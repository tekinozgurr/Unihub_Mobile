<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>UniHub</title>
    <meta name="app-version" content="1.0.0">

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#f1f5f9">
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/3406/3406546.png">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3406/3406546.png">

    <style>
        /* --- CSS AYNI KALDI --- */
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --bg: #f1f5f9;
            --card: #ffffff;
            --text: #0f172a;
            --sub: #64748b;
            --accent: #0f172a;
            --border: #e2e8f0;
            --dock-bg: rgba(255, 255, 255, 0.85);
            --modal-bg: #ffffff;
            --input-bg: #f1f5f9;
            --c1: #22c55e;
            --c2: #facc15;
            --c3: #f97316;
            --c4: #ef4444;
            --dark-red: #991b1b;
            --seg-empty: #f1f5f9;
            --shadow-soft: 0 10px 30px -10px rgba(0, 0, 0, 0.08);
            --shadow-dock: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        [data-theme="dark"] {
            --bg: #020617;
            --card: #0f172a;
            --text: #f8fafc;
            --sub: #94a3b8;
            --accent: #38bdf8;
            --border: #1e293b;
            --dock-bg: rgba(15, 17, 42, 0.85);
            --modal-bg: #0f172a;
            --seg-empty: #1e293b;
            --shadow-soft: 0 10px 30px -10px rgba(0, 0, 0, 0.5);
            --input-bg: #1e293b;
        }

        body {
            margin: 0;
            padding: max(20px, env(safe-area-inset-top)) 20px 110px 20px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            transition: background 0.3s, color 0.3s;
            overflow-x: hidden;
        }

        /* HEADER */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-top: 10px;
        }

        .h-title {
            font-size: 32px;
            font-weight: 800;
            letter-spacing: -1px;
        }

        .h-date {
            font-size: 13px;
            color: var(--sub);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .menu-btn {
            width: 44px;
            height: 44px;
            border-radius: 14px;
            background: var(--card);
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 5px;
            box-shadow: var(--shadow-soft);
            cursor: pointer;
            z-index: 200;
        }

        .menu-btn span {
            width: 20px;
            height: 2px;
            background: var(--text);
            border-radius: 2px;
            transition: all 0.3s ease;
            transform-origin: center;
        }

        .menu-btn.active span:nth-child(1) {
            transform: translateY(7px) rotate(45deg);
        }

        .menu-btn.active span:nth-child(2) {
            opacity: 0;
        }

        .menu-btn.active span:nth-child(3) {
            transform: translateY(-7px) rotate(-45deg);
        }

        /* FLOATING MENU */
        .floating-menu {
            position: fixed;
            top: 80px;
            right: 20px;
            width: 220px;
            background: var(--modal-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            gap: 5px;
            opacity: 0;
            transform: translateY(-15px) scale(0.95);
            pointer-events: none;
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            z-index: 199;
        }

        .floating-menu.open {
            opacity: 1;
            transform: translateY(0) scale(1);
            pointer-events: all;
        }

        .fm-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px;
            border-radius: 14px;
            background: transparent;
            border: none;
            color: var(--text);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            text-align: left;
        }

        .fm-item:active {
            background: var(--input-bg);
        }

        .fm-item svg {
            width: 20px;
            height: 20px;
            min-width: 20px;
            fill: currentColor;
        }

        /* CARDS & ITEMS */
        .hero-card {
            background: var(--text);
            color: var(--bg);
            border-radius: 24px;
            padding: 25px;
            margin-bottom: 30px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 20px 40px -5px rgba(0, 0, 0, 0.3);
            display: none;
            animation: slideDown 0.5s;
        }

        .hc-label {
            font-size: 11px;
            opacity: 0.7;
            text-transform: uppercase;
            font-weight: 800;
            letter-spacing: 1px;
        }

        .hc-main {
            font-size: 26px;
            font-weight: 800;
            margin: 6px 0;
        }

        .hc-sub {
            font-size: 14px;
            opacity: 0.9;
            font-weight: 500;
        }

        .hc-decor {
            position: absolute;
            right: -20px;
            bottom: -30px;
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: currentColor;
            opacity: 0.08;
        }

        .course-item {
            background: var(--card);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 20px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow-soft);
            transition: transform 0.2s;
            position: relative;
        }

        .course-item:active {
            transform: scale(0.98);
        }

        .cc-time {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-width: 55px;
            text-align: center;
            padding-right: 20px;
            border-right: 2px solid var(--border);
        }

        .cc-hour {
            font-size: 18px;
            font-weight: 800;
            color: var(--text);
            line-height: 1;
        }

        .cc-min {
            font-size: 13px;
            color: var(--sub);
            font-weight: 600;
            margin-top: 2px;
        }

        .cc-info {
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .cc-name {
            font-size: 17px;
            font-weight: 700;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: var(--text);
        }

        .cc-loc {
            font-size: 12px;
            color: var(--sub);
            font-weight: 700;
            display: inline-block;
            width: fit-content;
            background: var(--bg);
            padding: 4px 10px;
            border-radius: 8px;
        }

        /* DOCK */
        .dock-container {
            position: fixed;
            bottom: 30px;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: center;
            z-index: 1000;
            pointer-events: none;
        }

        .dock {
            background: var(--dock-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            padding: 8px;
            border-radius: 24px;
            display: flex;
            gap: 8px;
            box-shadow: var(--shadow-dock);
            border: 1px solid var(--border);
            pointer-events: auto;
        }

        .dock-item {
            padding: 12px 16px;
            border-radius: 16px;
            color: var(--sub);
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .dock-item.active {
            background: var(--text);
            color: var(--bg);
            box-shadow: 0 5px 15px -5px rgba(0, 0, 0, 0.3);
            transform: translateY(-3px);
        }

        .dock-icon svg {
            width: 22px;
            height: 22px;
            fill: currentColor;
        }

        .dock-text {
            font-size: 10px;
        }

        /* ATTENDANCE */
        .att-item {
            background: var(--card);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            border: 1px solid var(--border);
            border-left: 4px solid var(--seg-empty);
            box-shadow: var(--shadow-soft);
            transition: all 0.3s ease;
        }

        .att-item.limit-reached {
            border-color: var(--c4) !important;
            border-left-width: 4px;
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.2);
        }

        .shake-it {
            animation: shake 0.4s cubic-bezier(.36, .07, .19, .97) both;
        }

        @keyframes shake {

            10%,
            90% {
                transform: translate3d(-1px, 0, 0);
            }

            20%,
            80% {
                transform: translate3d(2px, 0, 0);
            }

            30%,
            50%,
            70% {
                transform: translate3d(-4px, 0, 0);
            }

            40%,
            60% {
                transform: translate3d(4px, 0, 0);
            }
        }

        .att-mid {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 10px;
            overflow: hidden;
        }

        .att-name {
            font-size: 16px;
            font-weight: 800;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .segment-container {
            display: flex;
            gap: 5px;
            height: 10px;
            width: 100%;
        }

        .segment {
            flex: 1;
            background: var(--seg-empty);
            border-radius: 3px;
            transition: all 0.3s;
            transform-origin: bottom;
        }

        .segment.active {
            transform: scaleY(1.4);
        }

        .segment.s1.active {
            background: var(--c1);
            box-shadow: 0 0 8px var(--c1);
        }

        .segment.s2.active {
            background: var(--c2);
            box-shadow: 0 0 8px var(--c2);
        }

        .segment.s3.active {
            background: var(--c3);
            box-shadow: 0 0 8px var(--c3);
        }

        .segment.s4.active {
            background: var(--c4);
            box-shadow: 0 0 8px var(--c4);
        }

        .att-right {
            display: flex;
            gap: 8px;
        }

        .btn-att-ctrl {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: var(--bg);
            color: var(--text);
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .btn-att-ctrl:active {
            transform: scale(0.92);
        }

        .btn-plus {
            color: var(--c3);
            background: rgba(249, 115, 22, 0.1);
            border-color: transparent;
        }

        .btn-plus:disabled {
            opacity: 0.3;
            cursor: not-allowed;
            transform: none;
        }

        /* CALENDAR */
        .cal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 0 5px;
        }

        .cal-month-title {
            font-size: 18px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-cal-nav {
            background: var(--card);
            border: 1px solid var(--border);
            width: 36px;
            height: 36px;
            border-radius: 12px;
            font-weight: bold;
            cursor: pointer;
            color: var(--text);
            box-shadow: var(--shadow-soft);
        }

        .cal-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            margin-bottom: 30px;
        }

        .cal-day-name {
            text-align: center;
            font-size: 11px;
            font-weight: 700;
            color: var(--sub);
            text-transform: uppercase;
        }

        .cal-day {
            aspect-ratio: 1;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 700;
            background: var(--card);
            color: var(--text);
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }

        .cal-day.term-start {
            border: 2px dashed var(--c1) !important;
            background: rgba(34, 197, 94, 0.1); /* Hafif yeÅŸil zemin ekledim */
        }

        .cal-day.term-end {
            border: 2px dashed var(--c4) !important;
            background: rgba(239, 68, 68, 0.1); /* Hafif kÄ±rmÄ±zÄ± zemin ekledim */
        }

        .cal-day.fill-lesson {
            background: var(--accent);
            color: var(--bg);
            border-color: var(--accent);
        }

        .cal-day.fill-exam {
            background: var(--c2);
            color: #000000;
            border-color: var(--c2);
        }

        .cal-day.fill-absent {
            background: var(--c4);
            color: white;
            border-color: var(--c4);
            box-shadow: 0 4px 10px rgba(239, 68, 68, 0.4);
        }

        .cal-day.exam-week-line::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: var(--c2);
        }

        .cal-day.fill-exam.exam-week-line::after {
            display: none;
        }

        .cal-day.today {
            border: 2px solid var(--text);
            transform: scale(0.95);
        }

        .cal-day.selected {
            transform: scale(1.1);
            z-index: 10;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }

        .cal-day.has-event::after {
            content: '';
            position: absolute;
            bottom: 6px;
            width: 4px;
            height: 4px;
            border-radius: 50%;
            background: var(--c2);
        }

        .cal-day.has-absent::before {
            content: '';
            position: absolute;
            top: 6px;
            right: 6px;
            width: 5px;
            height: 5px;
            border-radius: 50%;
            background: var(--c4);
        }

        .cal-day.empty {
            background: transparent;
            cursor: default;
            border: none;
        }

        .event-card {
            background: var(--card);
            padding: 15px;
            border-radius: 16px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 12px;
            border-left: 4px solid var(--border);
            box-shadow: var(--shadow-soft);
        }

        .ec-exam {
            border-left-color: var(--c2);
        }

        .ec-absent {
            border-left-color: var(--c4);
        }

        .ec-lesson {
            border-left-color: var(--accent);
        }

        /* TABS & MODALS */
        .tab-content {
            display: none;
            animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .active-tab {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .empty-state {
            text-align: center;
            color: var(--sub);
            margin-top: 60px;
            font-size: 15px;
            font-weight: 500;
        }

        .update-badge {
            width: 8px;
            height: 8px;
            background: var(--c4);
            border-radius: 50%;
            margin-left: auto;
            display: none;
        }

        .grade-row {
            background: var(--card);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border: 1px solid var(--border);
            box-shadow: var(--shadow-soft);
            transition: transform 0.2s;
            position: relative;
            overflow: hidden;
        }

        .grade-row:active {
            transform: scale(0.98);
        }

        .grade-row::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 5px;
            background: var(--border);
        }

        .grade-row.status-ok::before {
            background: var(--c1);
        }

        .grade-row.status-risk::before {
            background: var(--c3);
        }

        .grade-row.status-fail::before {
            background: var(--c4);
        }

        .gr-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
            padding-left: 10px;
        }

        .gr-name {
            font-size: 17px;
            font-weight: 800;
            color: var(--text);
        }

        .gr-sub {
            font-size: 13px;
            color: var(--sub);
            font-weight: 600;
            display: flex;
            gap: 10px;
        }

        .gr-score {
            text-align: right;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }

        .gr-val {
            font-size: 20px;
            font-weight: 900;
            letter-spacing: -0.5px;
        }

        .gr-label {
            font-size: 11px;
            font-weight: 700;
            opacity: 0.8;
            text-transform: uppercase;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            z-index: 2000;
            display: none;
            justify-content: center;
            align-items: flex-end;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: var(--modal-bg);
            width: 100%;
            border-radius: 32px 32px 0 0;
            padding: 30px 25px 60px 25px;
            box-sizing: border-box;
            max-height: 92vh;
            overflow-y: auto;
            animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            box-shadow: 0 -10px 40px rgba(0, 0, 0, 0.2);
        }

        @keyframes slideUp {
            from {
                transform: translateY(100%);
            }

            to {
                transform: translateY(0);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .modal-title {
            font-size: 22px;
            font-weight: 800;
        }

        .btn-close {
            background: none;
            border: none;
            font-size: 30px;
            color: var(--sub);
            cursor: pointer;
        }

        .inp-row {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .inp-std {
            width: 100%;
            padding: 16px;
            border: 1px solid var(--border); /* <-- DEÄžÄ°ÅžEN KISIM: ArtÄ±k ÅŸeffaf deÄŸil */
            border-radius: 16px;
            font-size: 16px;
            background: var(--input-bg);
            color: var(--text);
            outline: none;
            font-weight: 600;
            transition: all 0.3s;
        }

        .inp-std:focus {
            background: var(--card);
            border-color: var(--text);
            box-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.1);
            transform: scale(1.02);
        }

        .btn-save-modal {
            width: 100%;
            background: var(--text);
            color: var(--bg);
            padding: 16px;
            border: none;
            border-radius: 16px;
            font-weight: 800;
            font-size: 15px;
            margin-top: 20px;
            box-shadow: 0 10px 20px -5px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s;
            letter-spacing: 0.5px;
        }

        .btn-save-modal:active {
            transform: scale(0.96);
        }

        .btn-delete-course {
            width: 100%;
            background: none;
            color: var(--c4);
            padding: 15px;
            border: none;
            font-weight: 700;
            margin-top: 10px;
        }

        .btn-backup {
            width: 100%;
            background: var(--input-bg);
            color: var(--text);
            padding: 18px;
            border: none;
            border-radius: 14px;
            font-weight: 600;
            margin-bottom: 12px;
            text-align: left;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .btn-update {
            width: 100%;
            background: var(--c1);
            color: white;
            padding: 20px;
            border: none;
            border-radius: 16px;
            font-weight: 800;
            font-size: 16px;
            margin-bottom: 25px;
            display: none;
            animation: bounce 1s infinite alternate;
        }

        /* BATCH ACTIONS */
        .batch-bar {
            display: none;
            justify-content: space-between;
            align-items: center;
            background: var(--card);
            padding: 10px 15px;
            border-radius: 16px;
            margin-bottom: 20px;
            border: 1px solid var(--border);
            animation: slideDown 0.3s;
        }

        .batch-left {
            display: flex;
            gap: 10px;
        }

        .btn-batch {
            padding: 8px 12px;
            border-radius: 10px;
            border: none;
            font-weight: 700;
            font-size: 13px;
            cursor: pointer;
        }

        .bb-select {
            background: var(--input-bg);
            color: var(--text);
        }

        .bb-delete {
            background: rgba(255, 71, 87, 0.1);
            color: var(--c4);
        }

        .bb-cancel {
            background: var(--text);
            color: var(--bg);
        }

        .course-item .edit-check {
            width: 0;
            opacity: 0;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .edit-mode .edit-check {
            width: 30px;
            opacity: 1;
            margin-right: 10px;
        }

        .check-circle {
            width: 20px;
            height: 20px;
            border: 2px solid var(--border);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: transparent;
            font-size: 12px;
        }

        .course-item.selected {
            border: 1px solid var(--c1);
            background: rgba(34, 197, 94, 0.05);
        }

        .course-item.selected .check-circle {
            background: var(--c1);
            border-color: var(--c1);
            color: white;
        }

        .day-section {
            margin-bottom: 30px;
        }

        .day-header {
            font-size: 12px;
            font-weight: 700;
            color: var(--sub);
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        textarea.imp-area {
            width: 100%;
            height: 120px;
            padding: 12px;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: var(--input-bg);
            color: var(--text);
            font-size: 13px;
            box-sizing: border-box;
            resize: vertical;
        }

        .imp-list {
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
            display: none;
        }

        .imp-item {
            display: flex;
            align-items: center;
            gap: 10px;
            background: var(--input-bg);
            padding: 12px;
            border-radius: 12px;
            margin-bottom: 8px;
            border: 2px solid transparent;
            cursor: pointer;
        }

        .imp-cb {
            width: 20px;
            height: 20px;
            accent-color: var(--c1);
        }

        .imp-info {
            flex: 1;
        }

        .imp-name {
            font-weight: bold;
            font-size: 14px;
        }

        .imp-det {
            font-size: 12px;
            color: var(--sub);
        }

        .btn-imp-toggle {
            background: var(--input-bg);
            color: var(--text);
            border: 1px solid var(--border);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            margin-left: 10px;
        }

        .imp-actions {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 10px;
        }

        label {
            font-size: 12px;
            color: var(--sub);
            margin-bottom: 8px;
            display: block;
            font-weight: 700;
            letter-spacing: 0.5px;
        }

        /* SPLASH & EMPTY */
        #splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            transition: opacity 0.5s ease-out, visibility 0.5s;
        }

        .splash-text {
            font-size: 42px;
            font-weight: 900;
            letter-spacing: -1.5px;
            color: var(--text);
            opacity: 0;
            transform: scale(0.8);
            animation: splashAnim 1.2s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        .splash-sub {
            margin-top: 10px;
            font-size: 14px;
            color: var(--sub);
            opacity: 0;
            animation: fadeIn 0.5s ease-out 0.5s forwards;
            letter-spacing: 2px;
            text-transform: uppercase;
            font-weight: 700;
        }

        .hide-splash {
            opacity: 0 !important;
            visibility: hidden !important;
        }

        .empty-placeholder {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 60vh;
            color: var(--sub);
            opacity: 0.3;
            cursor: pointer;
            transition: opacity 0.3s;
            text-align: center;
        }

        .empty-placeholder:active {
            opacity: 0.6;
            transform: scale(0.95);
        }

        .empty-plus {
            font-size: 80px;
            font-weight: 200;
            line-height: 1;
            margin-bottom: 10px;
        }

        .empty-text {
            font-size: 18px;
            font-weight: 600;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        @keyframes splashAnim {
            0% {
                opacity: 0;
                transform: scale(0.8);
            }

            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        .ci-badge {
            font-size: 12px;
            font-weight: 600;
            padding: 5px 10px;
            border-radius: 8px;
            background: var(--input-bg);
            color: var(--text);
        }

        .cal-day.selected.term-start {
            border: 2px dashed #ffffff !important; /* Beyaz yap */
            box-shadow: 0 0 10px var(--c1); /* Arkaya yeÅŸil Ä±ÅŸÄ±k ver */
        }
        .cal-day.selected.term-end {
            border: 2px dashed #ffffff !important;
            box-shadow: 0 0 10px var(--c4); /* Arkaya kÄ±rmÄ±zÄ± Ä±ÅŸÄ±k ver */
        }

        /* --- KESÄ°N DÃœZELTMELER (EN ALTA EKLE) --- */

        /* 1. Ayarlar KutularÄ±nÄ± GÃ¶rÃ¼nÃ¼r Yap */
        /* Standart border rengi yerine daha belirgin bir renk zorluyoruz */
        .inp-std {
            border: 1px solid var(--sub) !important; 
            background: var(--bg) !important; /* Hafif kontrast olsun */
        }
        
        /* 2. Takvim DÃ¶nem BaÅŸÄ± (YeÅŸil) - Normal Hali */
        .cal-day.term-start {
            border: 2px dashed var(--c1) !important;
            background: rgba(34, 197, 94, 0.15) !important;
            z-index: 5; /* DiÄŸerlerinin Ã¼stÃ¼ne Ã§Ä±ksÄ±n */
        }

        /* 3. Takvim DÃ¶nem BaÅŸÄ± (YeÅŸil) - SEÃ‡Ä°LÄ° HALÄ° (Sorunlu KÄ±sÄ±m) */
        /* SeÃ§iliyken yeÅŸil kenarlÄ±k kayboluyordu, ÅŸimdi BEYAZ yapÄ±p arkaya YEÅžÄ°L Ä±ÅŸÄ±k veriyoruz */
        .cal-day.selected.term-start {
            background: var(--text) !important; /* Mavi/Siyah seÃ§ili rengi */
            color: var(--bg) !important;
            border: 3px solid #ffffff !important; /* KalÄ±n Beyaz Ã‡erÃ§eve */
            box-shadow: 0 0 15px var(--c1) !important; /* Arkadan YeÅŸil Parlama */
        }

        /* 4. Takvim DÃ¶nem Sonu (KÄ±rmÄ±zÄ±) - SeÃ§ili Hali */
        .cal-day.selected.term-end {
            background: var(--text) !important;
            color: var(--bg) !important;
            border: 3px solid #ffffff !important; /* KalÄ±n Beyaz Ã‡erÃ§eve */
            box-shadow: 0 0 15px var(--c4) !important; /* Arkadan KÄ±rmÄ±zÄ± Parlama */
        }
    </style>
</head>

<body>
    <div id="splash-screen">
        <div class="splash-text">UniHub</div>
        <div class="splash-sub">HoÅŸ Geldin</div>
    </div>

    <header>
        <div>
            <div class="h-date" id="headerDate">...</div>
            <div class="h-title" id="pageTitle">BugÃ¼n</div>
        </div>
        <button class="menu-btn" onclick="toggleMenu()" id="menuBtn"><span></span><span></span><span></span></button>
    </header>

    <div id="floatingMenu" class="floating-menu">
        <button class="fm-item" onclick="handleMenuClick('add')"><svg viewBox="0 0 24 24">
                <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z" />
            </svg> Ders Ekle</button>
        <button class="fm-item" onclick="handleMenuClick('import')"><span style="font-size:20px">ðŸª„</span> Ä°Ã§e
            Aktar</button>
        <button class="fm-item" onclick="handleMenuClick('theme')"><span style="font-size:18px"
                id="menuThemeIcon">â˜¾</span> Tema DeÄŸiÅŸtir</button>
        <div style="height:1px; background:var(--border); margin:4px 0;"></div>
        <button class="fm-item" onclick="handleMenuClick('settings')"><svg viewBox="0 0 24 24">
                <path
                    d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58a.49.49 0 0 0 .12-.61l-1.92-3.32a.488.488 0 0 0-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54a.484.484 0 0 0-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58a.49.49 0 0 0-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z" />
            </svg> Ayarlar <div class="update-badge" id="menuUpdateBadge"></div></button>
    </div>

    <div id="tab-program" class="tab-content active-tab">
        <div id="statusCard" class="hero-card">
            <div class="hc-label" id="scTitle">DURUM</div>
            <div class="hc-main" id="scMain">...</div>
            <div class="hc-sub" id="scSub">...</div>
            <div class="hc-decor"></div>
        </div>
        <div id="batchBar" class="batch-bar">
            <div class="batch-left">
                <button class="btn-batch bb-select" onclick="toggleSelectAll()">TÃ¼mÃ¼nÃ¼ SeÃ§</button>
                <button class="btn-batch bb-delete" onclick="deleteSelectedCourses()">Sil (<span
                        id="selCount">0</span>)</button>
            </div>
            <button class="btn-batch bb-cancel" onclick="toggleEditMode()">Bitti</button>
        </div>
        <div id="programList"></div>
        <div id="emptyMsg" class="empty-placeholder" style="display:none;" onclick="openNewCourseModal()">
            <div class="empty-plus">+</div>
            <div class="empty-text">Ders Ekle</div>
        </div>
    </div>

    <div id="tab-takvim" class="tab-content">
        <div class="cal-header">
            <button class="btn-cal-nav" onclick="changeMonth(-1)">â€¹</button>
            <span class="cal-month-title" id="calMonthTitle"></span>
            <button class="btn-cal-nav" onclick="changeMonth(1)">â€º</button>
        </div>
        <div class="cal-grid">
            <div class="cal-day-name">Pzt</div>
            <div class="cal-day-name">Sal</div>
            <div class="cal-day-name">Ã‡ar</div>
            <div class="cal-day-name">Per</div>
            <div class="cal-day-name">Cum</div>
            <div class="cal-day-name">Cmt</div>
            <div class="cal-day-name">Paz</div>
        </div>
        <div class="cal-grid" id="calendarGrid"></div>
        <div class="cal-detail-title"><span id="selectedDateText">BugÃ¼n</span></div>
        <div id="calendarDetail"></div>
    </div>

    <div id="tab-yoklama" class="tab-content">
        <div id="attendanceList"></div>
    </div>
    <div id="tab-notlar" class="tab-content">
        <div id="gradesList"></div>
    </div>

    <div class="dock-container">
        <div class="dock">
            <div class="dock-item active" onclick="switchTab('program', this)">
                <div class="dock-icon"><svg viewBox="0 0 24 24">
                        <path
                            d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20a2 2 0 0 0 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10zm0-12H5V6h14v2zm-7 5h5v5h-5v-5z" />
                    </svg></div>
                <span class="dock-text">Program</span>
            </div>
            <div class="dock-item" onclick="switchTab('takvim', this)">
                <div class="dock-icon"><svg viewBox="0 0 24 24">
                        <path
                            d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19a2 2 0 0 0 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z" />
                    </svg></div>
                <span class="dock-text">Takvim</span>
            </div>
            <div class="dock-item" onclick="switchTab('yoklama', this)">
                <div class="dock-icon"><svg viewBox="0 0 24 24">
                        <path
                            d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-9 14l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z" />
                    </svg></div>
                <span class="dock-text">Yoklama</span>
            </div>
            <div class="dock-item" onclick="switchTab('notlar', this)">
                <div class="dock-icon"><svg viewBox="0 0 24 24">
                        <path
                            d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-6 13h-2v-2h2v2zm0-4h-2v-2h2v2zm0-4h-2v-2h2v2zm4 8h-2v-2h2v2zm0-4h-2v-2h2v2zm0-4h-2v-2h2v2z" />
                    </svg></div>
                <span class="dock-text">Notlar</span>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="courseModal" onclick="if(event.target === this) closeModal('courseModal')">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-title" id="mTitle">Ders Ekle</span>
                <button class="btn-close" onclick="closeModal('courseModal')">Ã—</button>
            </div>
            <input type="hidden" id="mId">
            <label>DERS BÄ°LGÄ°LERÄ°</label>
            <div class="inp-row"><input type="text" id="mName" class="inp-std" placeholder="Ders AdÄ±"></div>
            <div class="inp-row">
                <select id="mDay" class="inp-std">
                    <option value="1">Pazartesi</option>
                    <option value="2">SalÄ±</option>
                    <option value="3">Ã‡arÅŸamba</option>
                    <option value="4">PerÅŸembe</option>
                    <option value="5">Cuma</option>
                </select>
            </div>
            <div class="inp-row">
                <input type="time" id="mTime" class="inp-std">
                <input type="text" id="mRoom" class="inp-std" placeholder="SÄ±nÄ±f (Online/D101)">
            </div>
            <div class="inp-row"><input type="number" id="mLimit" class="inp-std" placeholder="Hak (0 yazarsan Muaf)"
                    value="4"></div>
            <label style="margin-top:20px;">SINAVLAR & TARÄ°HLER</label>
            <div class="inp-row">
                <div style="flex:1"><label>Vize Puan</label><input type="number" id="mVize" class="inp-std"
                        placeholder="Not" oninput="liveCalc()"></div>
                <div style="flex:1"><label>Oran %</label><input type="number" id="mVizeR" class="inp-std" value="40"
                        oninput="liveCalc()"></div>
            </div>
            <div class="inp-row"><input type="date" id="mVizeDate" class="inp-std" placeholder="Vize Tarihi"></div>
            <div class="inp-row">
                <div style="flex:1"><label>Proje Puan</label><input type="number" id="mProj" class="inp-std"
                        placeholder="Not" oninput="liveCalc()"></div>
                <div style="flex:1"><label>Oran %</label><input type="number" id="mProjR" class="inp-std" value="0"
                        oninput="liveCalc()"></div>
            </div>
            <div class="inp-row">
                <div style="flex:1"><label>Final Puan</label><input type="number" id="mFinal" class="inp-std"
                        placeholder="Not" oninput="liveCalc()"></div>
                <div style="flex:1"><label>Oran %</label><input type="number" id="mFinalR" class="inp-std" value="60"
                        disabled style="opacity:0.6"></div>
            </div>
            <div class="inp-row"><input type="date" id="mFinalDate" class="inp-std" placeholder="Final Tarihi"></div>
            <div id="mCalcResult" class="calc-result" style="display:none;"></div>
            <button class="btn-save-modal" onclick="saveCourse()">Kaydet</button>
            <button class="btn-delete-course" id="btnDelete" onclick="deleteCourse()">Dersi Sil</button>
        </div>
    </div>

    <div class="modal-overlay" id="importModal" onclick="if(event.target === this) closeModal('importModal')">
        <div class="modal-content">
            <div class="modal-header"><span class="modal-title">Sihirli Ä°Ã§e Aktar âœ¨</span><button class="btn-close"
                    onclick="closeModal('importModal')">Ã—</button></div>
            <p style="font-size:13px; color:var(--text-sub);">AplanCloud'dan ders tablosunu kopyala ve aÅŸaÄŸÄ±ya yapÄ±ÅŸtÄ±r.
            </p>
            <textarea id="impText" class="imp-area" placeholder="Metni buraya yapÄ±ÅŸtÄ±r..."></textarea>
            <div class="imp-actions">
                <button class="btn-save-modal"
                    style="margin-top:10px; flex:1; margin-right:5px; background:var(--text);"
                    onclick="analyzeImport()">Ders Prog. ðŸ“…</button>
                <button class="btn-save-modal" style="margin-top:10px; flex:1; margin-left:5px; background:var(--c3);"
                    onclick="analyzeExamImport()">SÄ±nav Takvimi ðŸŽ“</button>
                <button id="btnToggleAll" class="btn-imp-toggle" style="display:none; margin-top:10px;"
                    onclick="toggleImpAll()">TÃ¼mÃ¼</button>
            </div>
            <div id="impList" class="imp-list"></div>
            <button id="btnImpSave" class="btn-save-modal"
                style="display:none; background:var(--c1); color:#ffffff; box-shadow: 0 10px 20px rgba(34, 197, 94, 0.3);"
                onclick="saveImportedCourses()">SeÃ§ilenleri Kaydet âœ…</button>
        </div>
    </div>

    <div class="modal-overlay" id="settingsModal" onclick="if(event.target === this) closeModal('settingsModal')">
        <div class="modal-content">
            <div class="modal-header"><span class="modal-title">Ayarlar</span><button class="btn-close"
                    onclick="closeModal('settingsModal')">Ã—</button></div>
            <button id="btnUpdateApp" class="btn-update" onclick="reloadApp()">ðŸ“¥ Yeni SÃ¼rÃ¼mÃ¼ YÃ¼kle</button>
            <label>UYGULAMA</label>
            <button class="btn-backup"
                onclick="document.getElementById('changelogModal').style.display='flex'; closeModal('settingsModal')"><span>âœ¨
                    GeliÅŸim GeÃ§miÅŸi</span> <span>âž¡</span></button>
            <label>AKADEMÄ°K TAKVÄ°M AYARLARI ðŸ“…</label>
            <div style="background:var(--input-bg); padding:15px; border-radius:16px; margin-bottom:20px;">
                <div class="inp-row" style="margin-bottom:5px;"><label style="margin:0;">DÃ¶nem BaÅŸlangÄ±cÄ±</label></div>
                <div class="inp-row"><input type="date" id="setTermStart" class="inp-std"></div>
                <div class="inp-row" style="margin-bottom:5px;"><label style="margin:0;">DÃ¶nem BitiÅŸi (Derslerin
                        Kesilmesi)</label></div>
                <div class="inp-row"><input type="date" id="setTermEnd" class="inp-std"></div>
                <div style="height:1px; background:var(--border); margin:15px 0;"></div>
                <label style="margin-bottom:5px;">SÄ±nav HaftalarÄ± (Ã‡izgi GÃ¶sterimi)</label>
                <div class="inp-row"><input type="date" id="setVizeStart" class="inp-std"
                        placeholder="Vize BaÅŸlangÄ±Ã§"><input type="date" id="setVizeEnd" class="inp-std"
                        placeholder="Vize BitiÅŸ"></div>
                <div class="inp-row"><input type="date" id="setFinalStart" class="inp-std"
                        placeholder="Final BaÅŸlangÄ±Ã§"><input type="date" id="setFinalEnd" class="inp-std"
                        placeholder="Final BitiÅŸ"></div>
                <button class="btn-save-modal" onclick="saveTermDates()">Tarihleri Kaydet</button>
            </div>
            <label style="margin-top:20px;">VERÄ°</label>
            <button class="btn-backup" onclick="downloadBackup()"><span>YedeÄŸi Ä°ndir</span> <span>â¬‡</span></button>
            <button class="btn-backup" onclick="document.getElementById('fileInput').click()"><span>Yedek YÃ¼kle</span>
                <span>â¬†</span></button>
            <input type="file" id="fileInput" style="display:none" onchange="restoreBackup(this)">
            <div class="version-tag">UniHub v1.0.0</div>
        </div>
    </div>

    <div class="modal-overlay" id="changelogModal">
        <div class="modal-content">
            <div class="modal-header"><span class="modal-title">ðŸ“œ GeliÅŸim GÃ¼nlÃ¼ÄŸÃ¼</span><button class="btn-close"
                    onclick="closeChangelog()">Ã—</button></div>
            <div class="changelog-container">
                <div class="cl-item">
                    <span class="cl-version" style="color:var(--c1)">v1.0.0</span>
                    <span class="cl-desc">UniHub yayÄ±nda! ðŸš€</span>
                </div>
            </div>
            <button class="btn-save-modal" onclick="closeChangelog()">Harika!</button>
        </div>
    </div>

    <script>

        // --- HATA YAKALAYICI (Bunu en Ã¼ste koy) ---
        window.onerror = function(message, source, lineno, colno, error) {
            alert("HATA VAR!\n\nMesaj: " + message + "\nSatÄ±r: " + lineno);
        };

        const CURRENT_VERSION = '1.0.0';
        let termDates = JSON.parse(localStorage.getItem('term_dates')) || {};
        let isEditMode = false;
        let selectedCourses = new Set();
        let calCurrentDate = new Date();
        let calSelectedDate = new Date();
        let courses = [];
        const days = { 1: 'Pazartesi', 2: 'SalÄ±', 3: 'Ã‡arÅŸamba', 4: 'PerÅŸembe', 5: 'Cuma', 6: 'Cumartesi', 7: 'Pazar' };
        const svgMoon = 'â˜¾'; const svgSun = 'â˜€';

        try { courses = JSON.parse(localStorage.getItem('v4_hub_data')) || []; } catch { courses = []; }

        function getLcDateStr(d) {
            const date = d || new Date();
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${day}`;
        }

        // --- GÃœNCELLEME SÄ°STEMÄ° (GITHUB RELEASES UYUMLU) ---
        async function checkUpdate() {
            // 1. AYARLAR (BURAYI KENDÄ°NE GÃ–RE DÃœZENLE)
            const GITHUB_USER = "tekinozgurr"; // GitHub kullanÄ±cÄ± adÄ±n
            const GITHUB_REPO = "Unihub_Mobile"; // Repo ismin (Ã–rn: UniHub veya unihub-android)
            
            try {
                // Mevcut sÃ¼rÃ¼mÃ¼ meta etiketinden al
                const currentVer = document.querySelector('meta[name="app-version"]').content;
                console.log("Mevcut SÃ¼rÃ¼m:", currentVer);

                // GitHub API'den son release bilgisini Ã§ek
                const response = await fetch(`https://api.github.com/repos/${GITHUB_USER}/${GITHUB_REPO}/releases/latest`);
                if (!response.ok) return; // Ä°nternet yoksa veya repo gizliyse sessizce Ã§Ä±k

                const data = await response.json();
                const latestVer = data.tag_name.replace('v', ''); // "v1.0.2" -> "1.0.2"
                
                // APK indirme linkini bul (Assets iÃ§indeki .apk uzantÄ±lÄ± ilk dosya)
                const apkAsset = data.assets.find(asset => asset.name.endsWith('.apk'));
                const downloadUrl = apkAsset ? apkAsset.browser_download_url : data.html_url;

                console.log("GitHub SÃ¼rÃ¼mÃ¼:", latestVer);

                // SÃ¼rÃ¼m karÅŸÄ±laÅŸtÄ±rma (EÄŸer GitHub sÃ¼rÃ¼mÃ¼ daha bÃ¼yÃ¼kse gÃ¼ncelle)
                if (compareVersions(latestVer, currentVer) > 0) {
                    showUpdateModal({
                        version: latestVer,
                        notes: data.body || 'Hata dÃ¼zeltmeleri ve iyileÅŸtirmeler.',
                        downloadUrl: downloadUrl
                    });
                }
            } catch (e) {
                console.log("GÃ¼ncelleme kontrol hatasÄ±:", e);
            }
        }

        // YardÄ±mcÄ±: Versiyon KarÅŸÄ±laÅŸtÄ±rÄ±cÄ± (1.0.1 > 1.0.0 gibi)
        function compareVersions(v1, v2) {
            const p1 = v1.split('.').map(Number);
            const p2 = v2.split('.').map(Number);
            for (let i = 0; i < Math.max(p1.length, p2.length); i++) {
                const num1 = p1[i] || 0;
                const num2 = p2[i] || 0;
                if (num1 > num2) return 1;
                if (num1 < num2) return -1;
            }
            return 0;
        }

        function showUpdateModal(data) {
            const oldModal = document.getElementById('updateModal');
            if (oldModal) oldModal.remove();

            const modalHtml = `
                <div id="updateModal" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:9999; display:flex; justify-content:center; align-items:center; backdrop-filter: blur(5px);">
                    <div style="background:var(--card, #ffffff); width:85%; max-width:350px; padding:30px; border-radius:24px; text-align:center; box-shadow:0 10px 40px rgba(0,0,0,0.5);">
                        <div style="font-size:50px; margin-bottom:10px;">ðŸš€</div>
                        <h2 style="margin:5px 0; color:var(--text, #000); font-size:22px;">Yeni SÃ¼rÃ¼m Var!</h2>
                        <p style="color:var(--c1, #2563eb); font-weight:bold; font-size:18px; margin:5px 0;">v${data.version}</p>
                        <div style="background:var(--bg, #f1f5f9); padding:15px; border-radius:12px; margin:20px 0; text-align:left; font-size:14px; color:var(--sub, #64748b); max-height:100px; overflow-y:auto;">
                            ${data.notes.replace(/\n/g, '<br>')}
                        </div>
                        <button onclick="window.open('${data.downloadUrl}', '_system')" style="background:var(--text, #0f172a); color:var(--bg, #fff); border:none; padding:15px; border-radius:12px; font-weight:bold; font-size:16px; width:100%; cursor:pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">HEMEN GÃœNCELLE</button>
                        <button onclick="document.getElementById('updateModal').remove()" style="background:transparent; border:none; color:var(--sub, #94a3b8); margin-top:15px; font-size:14px; cursor:pointer;">Sonra HatÄ±rlat</button>
                    </div>
                </div>`;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        // --- BÄ°LDÄ°RÄ°M SÄ°STEMÄ° ---
        async function setupNotifications() {
            if (typeof Capacitor === 'undefined' || !Capacitor.Plugins.LocalNotifications) return;
            const LocalNotifications = Capacitor.Plugins.LocalNotifications;

            // DÃ¶nem bittiyse bildirim yok
            if (termDates.f2) {
                const todayStr = getLcDateStr(new Date());
                if (todayStr > termDates.f2) {
                    const pending = await LocalNotifications.getPending();
                    if (pending.notifications.length > 0) await LocalNotifications.cancel(pending);
                    return;
                }
            }

            try {
                const perm = await LocalNotifications.requestPermissions();
                if (perm.display !== 'granted') return;

                const pending = await LocalNotifications.getPending();
                if (pending.notifications.length > 0) await LocalNotifications.cancel(pending);

                let notifs = [];
                let idCounter = 1;
                const activeDays = [...new Set(courses.map(c => c.day))];

                activeDays.forEach(dayId => {
                    // Sabah 08:00
                    notifs.push({
                        id: idCounter++,
                        title: "GÃ¼naydÄ±n! â˜€ï¸",
                        body: `BugÃ¼n ${days[dayId]} ve derslerin var. ProgramÄ± kontrol et!`,
                        smallIcon: 'ic_stat_unihub',
                        iconColor: '#0f172a',
                        schedule: { on: { weekday: dayId === 7 ? 1 : dayId + 1, hour: 8, minute: 0 }, allowWhileIdle: true }
                    });
                    // AkÅŸam 20:00
                    notifs.push({
                        id: idCounter++,
                        title: "GÃ¼nÃ¼n Bitti ðŸŒ™",
                        body: "BugÃ¼nkÃ¼ yoklamalarÄ± girdin mi? Girmeyi unutma!",
                        smallIcon: 'ic_stat_unihub',
                        iconColor: '#0f172a',
                        schedule: { on: { weekday: dayId === 7 ? 1 : dayId + 1, hour: 20, minute: 0 }, allowWhileIdle: true }
                    });
                });

                if (notifs.length > 0) await LocalNotifications.schedule({ notifications: notifs });
            } catch (e) { console.error("Bildirim HatasÄ±:", e); }
        }

        // --- WIDGET ---
        async function saveToWidget() {
            try {
                if (typeof Capacitor === 'undefined' || !Capacitor.Plugins.Filesystem) return;
                const title = document.getElementById('scMain') ? document.getElementById('scMain').innerText : "UniHub";
                const info = document.getElementById('scSub') ? document.getElementById('scSub').innerText : "Durum GÃ¼ncellendi";
                const dataToWrite = title + "|" + info;
                await Capacitor.Plugins.Filesystem.writeFile({ path: 'unihub_widget.txt', data: dataToWrite, directory: 'DATA', encoding: 'utf8' });
            } catch (e) { console.error("Widget HatasÄ±:", e); }
        }

        function init() {
            try {
                initTheme();
                const now = new Date();
                document.getElementById('headerDate').innerText = now.toLocaleDateString('tr-TR', { weekday: 'long', day: 'numeric', month: 'long' });

                if (Array.isArray(courses)) {
                    courses.forEach(c => {
                        if (!c.absentDates) c.absentDates = [];
                        if (typeof c.limit === 'undefined') c.limit = 4;
                    });
                } else { courses = []; }

                checkChangelog();
                refreshUI();

                // Fonksiyonlar tanÄ±mlandÄ±ktan sonra Ã§aÄŸÄ±rÄ±yoruz
                setTimeout(checkUpdate, 3000);
                setupNotifications();

                // Widget Listener
                if (typeof Capacitor !== 'undefined' && Capacitor.Plugins.App) {
                    Capacitor.Plugins.App.addListener('appStateChange', ({ isActive }) => {
                        if (!isActive) {
                            updateDashboard();
                            saveToWidget();
                        }
                    });
                }

            } catch (e) { console.error(e); alert("Hata oluÅŸtu."); }
            finally {
                setTimeout(() => {
                    const s = document.getElementById('splash-screen');
                    s.classList.add('hide-splash');
                    setTimeout(() => { s.style.display = 'none' }, 500);
                }, 1800);
            }
        }

        // --- CORE FUNCTIONS ---
        function refreshUI() { renderProgram(); updateDashboard(); renderAttendance(); renderGrades(); renderCalendarGrid(); }
        function saveData() { localStorage.setItem('v4_hub_data', JSON.stringify(courses)); }
        function toggleMenu() { document.getElementById('menuBtn').classList.toggle('active'); document.getElementById('floatingMenu').classList.toggle('open'); }
        function handleMenuClick(action) {
            toggleMenu();
            setTimeout(() => {
                switch (action) {
                    case 'add': openNewCourseModal(); break;
                    case 'import': openImportModal(); break;
                    case 'theme': toggleTheme(); break;
                    case 'settings': openSettingsModal(); break;
                }
            }, 200);
        }
        document.addEventListener('click', (e) => {
            const b = document.getElementById('menuBtn'); const m = document.getElementById('floatingMenu');
            if (!b.contains(e.target) && !m.contains(e.target) && m.classList.contains('open')) toggleMenu();
        });
        function initTheme() {
            let s = localStorage.getItem('theme');
            if (!s) s = (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) ? 'dark' : 'light';
            document.documentElement.setAttribute('data-theme', s); updateThemeIcon(s);
            document.querySelector('meta[name="theme-color"]').setAttribute("content", s === 'dark' ? '#121212' : '#f1f5f9');
        }
        function toggleTheme() {
            const t = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', t); localStorage.setItem('theme', t); updateThemeIcon(t);
            document.querySelector('meta[name="theme-color"]').setAttribute("content", t === 'dark' ? '#121212' : '#f1f5f9');
        }
        function updateThemeIcon(t) { document.getElementById('menuThemeIcon').innerText = t === 'dark' ? svgSun : svgMoon; }

        let newWorker;
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.getRegistrations().then(r => { for (let reg of r) reg.unregister(); });
            if ('caches' in window) caches.keys().then(n => { for (let name of n) caches.delete(name); });
        }
        function reloadApp() { window.location.reload(); }
        function switchTab(n, e) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active-tab'));
            document.getElementById('tab-' + n).classList.add('active-tab');
            document.querySelectorAll('.dock-item').forEach(x => x.classList.remove('active'));
            e.classList.add('active');
            const titles = { 'program': 'BugÃ¼n', 'takvim': 'Takvim', 'yoklama': 'Yoklama', 'notlar': 'Notlar' };
            document.getElementById('pageTitle').innerText = titles[n];
        }

        let lpTimer;
        function startLP(id) {
            lpTimer = setTimeout(() => {
                if (navigator.vibrate) navigator.vibrate(50);
                if (!isEditMode) toggleEditMode();
                if (!selectedCourses.has(id)) toggleSelect(id);
            }, 600);
        }
        function cancelLP() { clearTimeout(lpTimer); }

        function renderProgram() {
            const l = document.getElementById('programList'); 
            const e = document.getElementById('emptyMsg');
            l.innerHTML = '';
            
            // BugÃ¼nÃ¼n tarihini al
            const todayStr = getLcDateStr(new Date());
            
            // EÄŸer bugÃ¼n sÄ±nav varsa en tepeye ekle (Bu Ã¶zellik kalsÄ±n, faydalÄ±)
            const todaysExams = courses.filter(c => c.vizeDate === todayStr || c.finalDate === todayStr);

            if (todaysExams.length > 0) {
                l.innerHTML += `<div class="day-header" style="color:var(--c2); margin-bottom:10px;">ðŸ“… BUGÃœNKÃœ SINAVLAR</div>`;
                todaysExams.forEach(c => {
                    const type = c.vizeDate === todayStr ? 'Vize SÄ±navÄ±' : 'Final SÄ±navÄ±';
                    l.innerHTML += `<div class="course-item" style="border-left:4px solid var(--c2);"><div class="cc-info"><div class="cc-name">${c.name}</div><div class="cc-loc">${type} â€¢ ${c.examRoom || c.room || 'Derslik Yok'}</div></div></div>`;
                });
                e.style.display = 'none';
            }

            // --- Ä°PTAL EDÄ°LEN KISIM BAÅžLANGICI ---
            // Eskiden burada "if (termDates.end && todayStr > termDates.end)..." vardÄ±.
            // O kodu sildik. ArtÄ±k dÃ¶nem bitse bile aÅŸaÄŸÄ±daki dÃ¶ngÃ¼ Ã§alÄ±ÅŸacak ve dersleri Ã§izecek.
            // --- Ä°PTAL EDÄ°LEN KISIM BÄ°TÄ°ÅžÄ° ---

            if (courses.length === 0) e.style.display = 'flex'; else e.style.display = 'none';

            // HaftanÄ±n gÃ¼nlerini dÃ¶n ve dersleri bas
            for (let d = 1; d <= 7; d++) {
                const dc = courses.filter(c => c.day == d).sort((a, b) => a.time.localeCompare(b.time));
                if (dc.length > 0) {
                    let h = `<div class="day-section"><div class="day-header">${days[d]}</div>`;
                    dc.forEach(c => {
                        const isSel = selectedCourses.has(c.id);
                        const clickAction = isEditMode ? `toggleSelect(${c.id})` : `openEditModal(${c.id})`;
                        const itemClass = `course-item ${isSel ? 'selected' : ''} ${isEditMode ? 'edit-mode' : ''}`;
                        const timeParts = c.time.split(':');
                        
                        // Not rozetlerini oluÅŸtur
                        let badgeHtml = '';
                        if (!isEditMode) {
                            if (c.final) {
                                badgeHtml = `<span class="ci-badge" style="background:var(--input-bg)">${c.average}</span>`;
                            } else if (c.vize) {
                                badgeHtml = `<span class="ci-badge">V: ${c.vize}</span>`;
                            }
                        }

                        h += `<div class="${itemClass}" onclick="${clickAction}" oncontextmenu="return false;" ontouchstart="startLP(${c.id})" ontouchend="cancelLP()" ontouchmove="cancelLP()" onmousedown="startLP(${c.id})" onmouseup="cancelLP()" onmouseleave="cancelLP()">
                            <div class="edit-check"><div class="check-circle">âœ“</div></div>
                            <div class="cc-time"><span class="cc-hour">${timeParts[0]}</span><span class="cc-min">${timeParts[1]}</span></div>
                            <div class="cc-info"><div class="cc-name">${c.name}</div><div class="cc-loc">${c.room || 'Derslik Yok'}</div></div>
                            ${badgeHtml}
                        </div>`;
                    });
                    l.innerHTML += h + '</div>';
                }
            }
        }

        function updateDashboard() {
            const c = document.getElementById('statusCard'), tT = document.getElementById('scTitle'), tM = document.getElementById('scMain'), tS = document.getElementById('scSub');
            if (courses.length === 0) { c.style.display = 'none'; return; }
            c.style.display = 'block';

            const now = new Date(), d = now.getDay(), h = now.getHours(), m = now.getMinutes(), nM = h * 60 + m;
            const todayId = d === 0 ? 7 : d;
            const tC = courses.filter(x => x.day == todayId).sort((a, b) => a.time.localeCompare(b.time));
            const todayStr = getLcDateStr(new Date());

            if (termDates.end && todayStr > termDates.end) {
                tT.innerText = "DURUM";
                if (termDates.f1 && todayStr >= termDates.f1 && todayStr <= termDates.f2) { tM.innerText = "SÄ±nav HaftasÄ±"; tS.innerText = "Takvimi kontrol et"; }
                else { tM.innerText = "DÃ¶nem Bitti"; tS.innerText = "Ä°yi Tatiller ðŸ–ï¸"; }
                saveToWidget(); return;
            }

            if (tC.length > 0) {
                let activeLesson = false;
                for (let x of tC) {
                    const p = x.time.split(':'), sM = parseInt(p[0]) * 60 + parseInt(p[1]), eM = sM + 50;
                    if (nM >= sM && nM < eM) {
                        tT.innerText = "ÅžU AN"; tM.innerText = x.name;
                        let endH = parseInt(p[0]), endM = parseInt(p[1]) + 50;
                        if (endM >= 60) { endH++; endM -= 60; }
                        tS.innerText = `BitiÅŸ: ${String(endH).padStart(2, '0')}:${String(endM).padStart(2, '0')} â€¢ ${x.room || ''}`;
                        activeLesson = true; break;
                    }
                    if (nM < sM) {
                        tT.innerText = "SIRADAKÄ°"; tM.innerText = x.name; tS.innerText = `BaÅŸlama: ${x.time} â€¢ ${x.room || 'Derslik Yok'}`;
                        activeLesson = true; break;
                    }
                }
                if (activeLesson) { saveToWidget(); return; }
            }

            tT.innerText = "GÃœN BÄ°TTÄ°"; tM.innerText = (d === 0 || d === 6) ? "Dinlen â˜•" : "Dersler Bitti";
            let nextDayName = "", found = false;
            for (let i = 1; i <= 7; i++) {
                let checkDay = (todayId + i); if (checkDay > 7) checkDay -= 7;
                if (courses.some(c => c.day === checkDay)) { nextDayName = (i === 1) ? "YarÄ±n" : days[checkDay]; found = true; break; }
            }
            tS.innerText = found ? `${nextDayName} gÃ¶rÃ¼ÅŸÃ¼rÃ¼z ðŸ‘‹` : "Ä°yi tatiller ðŸ¥³";
            saveToWidget();
        }

        function renderAttendance() {
            const l = document.getElementById('attendanceList'); l.innerHTML = '';
            [...courses].sort((a, b) => (a.day - b.day) || a.time.localeCompare(b.time)).forEach(c => {
                if (c.limit === 0) { l.innerHTML += `<div class="att-item" style="border-left:4px solid var(--accent);"><div class="att-mid"><span class="att-name">${c.name}</span><span class="ci-badge" style="width:fit-content">Muaf</span></div></div>`; return; }
                const isD = c.absent === c.limit;
                let segmentsHTML = '';
                for (let i = 0; i < c.limit; i++) {
                    const active = i < c.absent ? 'active' : ''; const colorClass = `s${(i % 4) + 1}`;
                    segmentsHTML += `<div class="segment ${colorClass} ${active}"></div>`;
                }
                let borderColor = 'var(--seg-empty)';
                if (c.absent > 0) borderColor = (c.absent === 1) ? 'var(--c1)' : (c.absent === 2) ? 'var(--c2)' : (c.absent === 3) ? 'var(--c3)' : 'var(--c4)';
                l.innerHTML += `<div class="att-item ${isD ? 'limit-reached shake-it' : ''}" id="att-item-${c.id}" style="border-left-color:${borderColor}">
                    <div class="att-mid"><span class="att-name">${c.name}</span><div class="segment-container" id="seg-cont-${c.id}">${segmentsHTML}</div></div>
                    <div class="att-right"><button class="btn-att-ctrl" onclick="updateAbsent(${c.id},-1)">âˆ’</button><button class="btn-att-ctrl btn-plus" id="btn-plus-${c.id}" onclick="updateAbsent(${c.id},1)" ${isD ? 'disabled' : ''}>+</button></div>
                </div>`;
            });
        }

        function updateSegmentRow(c) {
            const elItem = document.getElementById(`att-item-${c.id}`), elSegCont = document.getElementById(`seg-cont-${c.id}`), elBtn = document.getElementById(`btn-plus-${c.id}`);
            if (!elItem) return;
            let segmentsHTML = '';
            for (let i = 0; i < c.limit; i++) {
                const active = i < c.absent ? 'active' : ''; const colorClass = `s${(i % 4) + 1}`;
                segmentsHTML += `<div class="segment ${colorClass} ${active}"></div>`;
            }
            elSegCont.innerHTML = segmentsHTML;
            let borderColor = 'var(--seg-empty)';
            if (c.absent > 0) borderColor = (c.absent === 1) ? 'var(--c1)' : (c.absent === 2) ? 'var(--c2)' : (c.absent === 3) ? 'var(--c3)' : 'var(--c4)';
            elItem.style.borderLeftColor = borderColor;
            if (c.absent === c.limit) { elItem.classList.remove('limit-reached', 'shake-it'); void elItem.offsetWidth; elItem.classList.add('limit-reached', 'shake-it'); elBtn.disabled = true; }
            else { elItem.classList.remove('limit-reached', 'shake-it'); elBtn.disabled = false; }
        }

        function updateAbsent(id, chg) {
            const c = courses.find(x => x.id === id); if (!c) return;
            let d = new Date(); const todayId = d.getDay() === 0 ? 7 : d.getDay();
            if (c.day !== todayId) { let diff = (todayId - c.day + 7) % 7; d.setDate(d.getDate() - diff); }
            const targetDateStr = getLcDateStr(d);

            if (chg === 1 && c.absent < c.limit) {
                c.absent++; if (!c.absentDates) c.absentDates = [];
                if (!c.absentDates.includes(targetDateStr)) c.absentDates.push(targetDateStr);
            } else if (chg === -1 && c.absent > 0) {
                c.absent--;
                if (c.absentDates) {
                    const idx = c.absentDates.indexOf(targetDateStr);
                    if (idx > -1) c.absentDates.splice(idx, 1); else c.absentDates.pop();
                }
            }
            saveData(); updateSegmentRow(c); renderCalendarGrid();
        }

        function changeMonth(d) { calCurrentDate.setMonth(calCurrentDate.getMonth() + d); renderCalendarGrid(); }
        function renderCalendarGrid() {
            const g = document.getElementById('calendarGrid'); 
            const t = document.getElementById('calMonthTitle'); 
            g.innerHTML = '';
            
            const y = calCurrentDate.getFullYear(); 
            const m = calCurrentDate.getMonth();
            const mn = ["OCAK", "ÅžUBAT", "MART", "NÄ°SAN", "MAYIS", "HAZÄ°RAN", "TEMMUZ", "AÄžUSTOS", "EYLÃœL", "EKÄ°M", "KASIM", "ARALIK"];
            
            t.innerText = `${mn[m]} ${y}`;
            
            const fd = new Date(y, m, 1).getDay(); 
            const dim = new Date(y, m + 1, 0).getDate(); 
            const so = fd === 0 ? 6 : fd - 1;
            
            for (let i = 0; i < so; i++) g.innerHTML += `<div class="cal-day empty"></div>`;
            
            const todayStr = getLcDateStr(new Date());
            
            for (let d = 1; d <= dim; d++) {
                const dateObj = new Date(y, m, d); 
                const dateStr = getLcDateStr(dateObj); 
                const dayId = dateObj.getDay() === 0 ? 7 : dateObj.getDay();
                
                let classes = 'cal-day'; 
                if (dateStr === todayStr) classes += ' today';
                if (dateObj.getTime() === calSelectedDate.getTime()) classes += ' selected';
                
                // DÃ¶nem baÅŸÄ±/sonu iÅŸaretleri
                if (termDates.start && dateStr === termDates.start) classes += ' term-start';
                if (termDates.end && dateStr === termDates.end) classes += ' term-end';

                // SÄ±nav haftasÄ± kontrolÃ¼
                let isExamWeek = false;
                if (termDates.v1 && termDates.v2 && dateStr >= termDates.v1 && dateStr <= termDates.v2) isExamWeek = true;
                if (termDates.f1 && termDates.f2 && dateStr >= termDates.f1 && dateStr <= termDates.f2) isExamWeek = true;
                if (isExamWeek) classes += ' exam-week-line';

                let isAbsent = courses.some(x => x.absentDates && x.absentDates.includes(dateStr));
                let isExamDay = courses.some(x => x.vizeDate === dateStr || x.finalDate === dateStr);
                let isLessonDay = courses.some(x => x.day == dayId);
                
                // --- FÄ°LTRELEME (YENÄ° KISIM) ---
                // 1. DÃ¶nem baÅŸlamadÄ±ysa ders yok
                if (termDates.start && dateStr < termDates.start) isLessonDay = false;
                // 2. DÃ¶nem bittiyse ders yok
                if (termDates.end && dateStr > termDates.end) isLessonDay = false;
                // 3. SÄ±nav haftasÄ±ysa ders yok (Ã‡izgi var ama ders noktasÄ± yok)
                if (isExamWeek) isLessonDay = false;
                // -------------------------------

                if (isAbsent) classes += ' fill-absent'; 
                else if (isExamDay) classes += ' fill-exam'; 
                else if (isLessonDay) classes += ' fill-lesson';
                
                g.innerHTML += `<div class="${classes}" onclick="selectDate(${y},${m},${d})">${d}</div>`;
            }
            renderDayDetail();
        }

        function selectDate(y, m, d) { calSelectedDate = new Date(y, m, d); renderCalendarGrid(); }
        function renderDayDetail() {
            const det = document.getElementById('calendarDetail'); 
            const txt = document.getElementById('selectedDateText');
            det.innerHTML = ''; 
            
            const d = calSelectedDate; 
            const ds = getLcDateStr(d); 
            const did = d.getDay() === 0 ? 7 : d.getDay();
            
            txt.innerText = d.toLocaleDateString('tr-TR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            let hc = false;

            // SÄ±navlar ve DevamsÄ±zlÄ±klar (Her zaman gÃ¶rÃ¼nÃ¼r)
            courses.forEach(c => {
                if (c.vizeDate === ds) { det.innerHTML += `<div class="event-card ec-exam"><div><strong>${c.name}</strong><br><span style="font-size:12px">Vize SÄ±navÄ±</span></div></div>`; hc = true; }
                if (c.finalDate === ds) { det.innerHTML += `<div class="event-card ec-exam"><div><strong>${c.name}</strong><br><span style="font-size:12px">Final SÄ±navÄ± ${c.examRoom ? 'â€¢ ðŸ“ ' + c.examRoom : ''}</span></div></div>`; hc = true; }
                if (c.absentDates && c.absentDates.includes(ds)) { det.innerHTML += `<div class="event-card ec-absent"><div><strong>${c.name}</strong><br><span style="font-size:12px">Derse katÄ±lmadÄ±n</span></div></div>`; hc = true; }
            });

            // Dersleri gÃ¶sterelim mi? (Filtre KontrolÃ¼)
            let showLessons = true;
            
            // 1. SÄ±nav HaftasÄ±ysa ders gÃ¶sterme
            if (termDates.v1 && termDates.v2 && ds >= termDates.v1 && ds <= termDates.v2) showLessons = false;
            if (termDates.f1 && termDates.f2 && ds >= termDates.f1 && ds <= termDates.f2) showLessons = false;
            
            // 2. DÃ¶nem dÄ±ÅŸÄ±ndaysa ders gÃ¶sterme
            if (termDates.start && ds < termDates.start) showLessons = false;
            if (termDates.end && ds > termDates.end) showLessons = false;

            if (showLessons) {
                const tc = courses.filter(x => x.day == did).sort((a, b) => a.time.localeCompare(b.time));
                if (tc.length > 0) { 
                    tc.forEach(c => { 
                        det.innerHTML += `<div class="event-card ec-lesson"><div><strong>${c.name}</strong><br><span style="font-size:12px">${c.time} â€¢ ${c.room || 'Derslik Yok'}</span></div></div>`; 
                    }); 
                    hc = true; 
                }
            } else if (!hc) {
                // EÄŸer sÄ±nav/devamsÄ±zlÄ±k da yoksa ve dersler gizlendiyse sebep yaz
                let reason = "Ders yok";
                if (termDates.start && ds < termDates.start) reason = "DÃ¶nem baÅŸlamadÄ± â³";
                else if (termDates.end && ds > termDates.end) reason = "DÃ¶nem bitti ðŸ–ï¸";
                else if (!showLessons) reason = "SÄ±nav HaftasÄ± ðŸ“š";
                
                det.innerHTML = `<div style="text-align:center; color:var(--sub); margin-top:20px; font-weight:600">${reason}</div>`;
                return; // AÅŸaÄŸÄ±daki "Etkinlik yok" yazmasÄ±n diye
            }

            if (!hc) det.innerHTML = '<div style="text-align:center; color:var(--sub); margin-top:20px;">Etkinlik yok.</div>';
        }

        function renderGrades() {
            const l = document.getElementById('gradesList'); l.innerHTML = '';
            if (courses.length === 0) { l.innerHTML = '<div class="empty-state">HenÃ¼z ders eklenmemiÅŸ.</div>'; return; }
            courses.forEach(c => {
                const v = parseFloat(c.vize) || 0, p = parseFloat(c.proj) || 0, f = parseFloat(c.final);
                const vr = c.rates?.vize || 40, pr = c.rates?.proj || 0, fr = 100 - vr - pr;
                let statusClass = '', scoreHTML = '', subText = '';
                if (!isNaN(f)) {
                    const avg = ((v * vr / 100) + (p * pr / 100) + (f * fr / 100)).toFixed(1);
                    c.average = avg;
                    if (avg >= 50) { statusClass = 'status-ok'; scoreHTML = `<div class="gr-val" style="color:var(--c1)">${avg}</div><div class="gr-label">GeÃ§ti</div>`; }
                    else { statusClass = 'status-fail'; scoreHTML = `<div class="gr-val" style="color:var(--c4)">${avg}</div><div class="gr-label">KaldÄ±</div>`; }
                    subText = `Final: ${f}`;
                } else {
                    const currentTotal = (v * vr / 100) + (p * pr / 100);
                    const needed = 50 - currentTotal;
                    const target = Math.ceil((needed / fr) * 100);
                    if (target <= 0) { statusClass = 'status-ok'; scoreHTML = `<div class="gr-val" style="color:var(--c1)">Garantiledin</div><div class="gr-label">Rahat ol</div>`; }
                    else if (target > 100) { statusClass = 'status-fail'; scoreHTML = `<div class="gr-val" style="color:var(--c4)">Riskli</div><div class="gr-label">Ã‡ok zor</div>`; }
                    else { statusClass = 'status-risk'; scoreHTML = `<div class="gr-val" style="color:var(--c3)">${target}</div><div class="gr-label">Final Hedefi</div>`; }
                    subText = `Vize: ${c.vize || '-'} ${c.proj ? 'â€¢ Prj: ' + c.proj : ''}`;
                }
                l.innerHTML += `<div class="grade-row ${statusClass}" onclick="openEditModal(${c.id})"><div class="gr-info"><span class="gr-name">${c.name}</span><span class="gr-sub">${subText}</span></div><div class="gr-score">${scoreHTML}</div></div>`;
            });
        }

        const m = document.getElementById('courseModal'); let curId = null;
        function openNewCourseModal() {
            curId = null; document.getElementById('mTitle').innerText = "Ders Ekle"; document.getElementById('btnDelete').style.display = 'none';
            document.querySelectorAll('.inp-std').forEach(i => i.value = ''); document.getElementById('mDay').value = '1'; document.getElementById('mTime').value = '09:00';
            document.getElementById('mLimit').value = '4'; document.getElementById('mVizeR').value = '40'; document.getElementById('mProjR').value = '0'; document.getElementById('mFinalR').value = '60';
            document.getElementById('mCalcResult').style.display = 'none'; m.style.display = 'flex';
        }
        function openEditModal(id) {
            const c = courses.find(x => x.id === id); if (!c) return;
            curId = id; document.getElementById('mTitle').innerText = "DÃ¼zenle"; document.getElementById('btnDelete').style.display = 'block';
            document.getElementById('mName').value = c.name; document.getElementById('mDay').value = c.day; document.getElementById('mTime').value = c.time;
            document.getElementById('mRoom').value = c.room || ''; document.getElementById('mLimit').value = c.limit;
            document.getElementById('mVize').value = c.vize || ''; document.getElementById('mVizeR').value = c.rates?.vize || 40; document.getElementById('mVizeDate').value = c.vizeDate || '';
            document.getElementById('mProj').value = c.proj || ''; document.getElementById('mProjR').value = c.rates?.proj || 0;
            document.getElementById('mFinal').value = c.final || ''; document.getElementById('mFinalDate').value = c.finalDate || '';
            liveCalc(); m.style.display = 'flex';
        }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        function openSettingsModal() {
            document.getElementById('settingsModal').style.display = 'flex';
            if (termDates.start) document.getElementById('setTermStart').value = termDates.start;
            if (termDates.end) document.getElementById('setTermEnd').value = termDates.end;
            if (termDates.v1) document.getElementById('setVizeStart').value = termDates.v1;
            if (termDates.v2) document.getElementById('setVizeEnd').value = termDates.v2;
            if (termDates.f1) document.getElementById('setFinalStart').value = termDates.f1;
            if (termDates.f2) document.getElementById('setFinalEnd').value = termDates.f2;
        }

        function saveCourse() {
            const n = document.getElementById('mName').value; if (!n) return alert('Ad giriniz');
            const nd = {
                id: curId || Date.now(), name: n, day: parseInt(document.getElementById('mDay').value), time: document.getElementById('mTime').value, room: document.getElementById('mRoom').value,
                limit: parseInt(document.getElementById('mLimit').value), absent: curId ? (courses.find(x => x.id == curId)?.absent || 0) : 0, absentDates: curId ? (courses.find(x => x.id == curId)?.absentDates || []) : [],
                vize: document.getElementById('mVize').value, vizeDate: document.getElementById('mVizeDate').value, proj: document.getElementById('mProj').value, final: document.getElementById('mFinal').value, finalDate: document.getElementById('mFinalDate').value,
                rates: { vize: parseInt(document.getElementById('mVizeR').value) || 0, proj: parseInt(document.getElementById('mProjR').value) || 0, final: 0 }, average: null
            };
            nd.rates.final = 100 - nd.rates.vize - nd.rates.proj;
            const v = parseFloat(nd.vize) || 0, p = parseFloat(nd.proj) || 0, f = parseFloat(nd.final) || 0;
            if (nd.vize && nd.final) { nd.average = ((v * nd.rates.vize / 100) + (p * nd.rates.proj / 100) + (f * nd.rates.final / 100)).toFixed(1); }
            if (curId) { const idx = courses.findIndex(x => x.id === curId); if (idx > -1) courses[idx] = nd; } else { courses.push(nd); }
            saveData(); refreshUI(); closeModal('courseModal');
        }

        function deleteCourse() { if (confirm('Sil?')) { courses = courses.filter(x => x.id !== curId); saveData(); refreshUI(); closeModal('courseModal'); } }
        function liveCalc() {
            const r = document.getElementById('mCalcResult'), v = parseFloat(document.getElementById('mVize').value), vr = parseInt(document.getElementById('mVizeR').value) || 0,
                p = parseFloat(document.getElementById('mProj').value), pr = parseInt(document.getElementById('mProjR').value) || 0, f = parseFloat(document.getElementById('mFinal').value), fr = 100 - vr - pr;
            document.getElementById('mFinalR').value = fr;
            if (isNaN(v)) { r.style.display = 'none'; return; }
            r.style.display = 'block'; let cur = (v * vr / 100); if (!isNaN(p)) cur += (p * pr / 100);
            if (!isNaN(f)) { let tot = cur + (f * fr / 100); r.innerHTML = `ORT: <strong>${tot.toFixed(1)}</strong>`; }
            else { let need = 50 - cur; r.innerHTML = need <= 0 ? "Garantiledin" : `Hedef: <strong>${Math.ceil((need / fr) * 100)}</strong>`; }
        }

        function toggleEditMode() {
            isEditMode = !isEditMode; selectedCourses.clear();
            const b = document.getElementById('batchBar'), s = document.getElementById('statusCard');
            if (isEditMode) { b.style.display = 'flex'; s.style.display = 'none'; } else { b.style.display = 'none'; updateDashboard(); }
            updateSelectionUI(); renderProgram();
        }
        function toggleSelect(id) { if (!isEditMode) return; if (selectedCourses.has(id)) selectedCourses.delete(id); else selectedCourses.add(id); updateSelectionUI(); renderProgram(); }
        function toggleSelectAll() { if (selectedCourses.size === courses.length) selectedCourses.clear(); else courses.forEach(c => selectedCourses.add(c.id)); updateSelectionUI(); renderProgram(); }
        function updateSelectionUI() { document.getElementById('selCount').innerText = selectedCourses.size; }
        function deleteSelectedCourses() { if (selectedCourses.size === 0) return alert("Ders seÃ§medin."); if (confirm("Silmek istiyor musun?")) { courses = courses.filter(c => !selectedCourses.has(c.id)); saveData(); refreshUI(); toggleEditMode(); } }

        let parsedCandidates = [];
        function openImportModal() {
            document.getElementById('importModal').style.display = 'flex'; document.getElementById('impText').value = '';
            document.getElementById('impList').innerHTML = ''; document.getElementById('btnImpSave').style.display = 'none'; document.getElementById('btnToggleAll').style.display = 'none';
        }
        // --- YENÄ°LENMÄ°Åž Ä°Ã‡E AKTAR SÄ°STEMÄ° ---

        // 1. Normal Ders ProgramÄ± Analizi
        function analyzeImport() {
            try {
                const text = document.getElementById('impText').value; 
                const cleanText = text.replace(/\t/g, ' ').replace(/\s+/g, ' ').replace(/[â€“â€”]/g, '-').trim();
                
                const dPatterns = [{ id: 1, name: 'Pazartesi', reg: /Pazartesi/gi }, { id: 2, name: 'SalÄ±', reg: /SalÄ±/gi }, { id: 3, name: 'Ã‡arÅŸamba', reg: /Ã‡arÅŸamba/gi }, { id: 4, name: 'PerÅŸembe', reg: /PerÅŸembe/gi }, { id: 5, name: 'Cuma', reg: /Cuma/gi }, { id: 6, name: 'Cumartesi', reg: /Cumartesi/gi }, { id: 7, name: 'Pazar', reg: /Pazar(?!tesi)/gi }];
                let dayIndices = []; 
                dPatterns.forEach(p => { let m; while ((m = p.reg.exec(cleanText)) !== null) dayIndices.push({ id: p.id, name: p.name, idx: m.index }); });
                dayIndices.sort((a, b) => a.idx - b.idx);
                
                if (dayIndices.length === 0) return alert("Metinde gÃ¼n ismi bulunamadÄ±.");
                
                parsedCandidates = []; 
                const list = document.getElementById('impList'); 
                list.innerHTML = '';
                
                const timeRegex = /(\d{1,2}[:.]\d{2})\s*-\s*(\d{1,2}[:.]\d{2})/g;
                
                for (let i = 0; i < dayIndices.length; i++) {
                    const cur = dayIndices[i]; 
                    const nxt = dayIndices[i + 1]; 
                    const block = cleanText.substring(cur.idx + cur.name.length, nxt ? nxt.idx : cleanText.length);
                    let tm; 
                    timeRegex.lastIndex = 0;
                    
                    while ((tm = timeRegex.exec(block)) !== null) {
                        const nextTmIndex = block.substring(tm.index + tm[0].length).search(/\d{1,2}[:.]\d{2}/);
                        const endOfEvent = nextTmIndex > -1 ? (tm.index + tm[0].length + nextTmIndex) : block.length;
                        const rawContent = block.substring(tm.index + tm[0].length, endOfEvent).trim();
                        
                        let name = rawContent.split('Derslik/Oda:')[0]; 
                        name = name.split('-')[1] || name.split('-')[0];
                        name = name.split(/Prof\.|DoÃ§\.|Dr\.|Ã–ÄŸr\.|ArÅŸ\.|Yrd\.|SÄ±nÄ±f:|Åžube:/i)[0]; 
                        name = name.trim();
                        
                        let room = ""; 
                        const roomMatch = rawContent.match(/Derslik\/Oda:\s*([A-Z0-9]+)/i); 
                        if (roomMatch) room = roomMatch[1]; 
                        else if (/Online|Uzaktan/i.test(rawContent)) room = "Online";
                        
                        if (name.length < 2) continue;
                        
                        const cid = Date.now() + Math.random();
                        // Type: 'course' ekledik
                        parsedCandidates.push({ type: 'course', id: cid, name: name, day: cur.id, time: tm[1].replace('.', ':'), room: room, limit: room === 'Online' ? 0 : 4 });
                        
                        // onchange eklendi
                        list.innerHTML += `<div class="imp-item" onclick="toggleImp('${cid}')"><input type="checkbox" id="chk_${cid}" class="imp-cb" checked onchange="updateImpBtn()"><div class="imp-info"><div class="imp-name">${name}</div><div class="imp-det">${cur.name} â€¢ ${tm[1]} â€¢ ðŸ“ ${room || '-'}</div></div></div>`;
                    }
                }
                
                if (parsedCandidates.length > 0) { 
                    list.style.display = 'block'; 
                    document.getElementById('btnToggleAll').style.display = 'block'; 
                    updateImpBtn(); // Butonu hazÄ±rla
                } else { 
                    alert("Ders saati formatÄ± bulunamadÄ±."); 
                }
            } catch (e) { console.error(e); alert("Hata: " + e.message); }
        }

        // 3. SÄ±nav Takvimi Analizi (GY1003 VE SINIF:4 AYIRIMLI)
        // 3. SÄ±nav Takvimi Analizi (TÄ°RE TEMÄ°ZLÄ°ÄžÄ° YAPILDI)
        function analyzeExamImport() {
            const textRaw = document.getElementById('impText').value;
            const list = document.getElementById('impList');
            list.innerHTML = '';
            parsedCandidates = [];

            if (!textRaw || textRaw.length < 5) return alert("Listeyi yapÄ±ÅŸtÄ±rÄ±n.");

            // 1. Temizlik
            const text = " " + textRaw.replace(/[\r\n\t]+/g, ' ').replace(/\s+/g, ' ') + " ";

            // 2. Tarihleri Bul
            const months = { "ocak": "01", "ÅŸubat": "02", "mart": "03", "nisan": "04", "mayÄ±s": "05", "haziran": "06", "temmuz": "07", "aÄŸustos": "08", "eylÃ¼l": "09", "ekim": "10", "kasÄ±m": "11", "aralÄ±k": "12" };
            const dateRegex = /(\d{1,2})\s+(Ocak|Åžubat|Mart|Nisan|MayÄ±s|Haziran|Temmuz|AÄŸustos|EylÃ¼l|Ekim|KasÄ±m|AralÄ±k)|(\d{1,2})[./-](\d{1,2})[./-](\d{2,4})/gi;
            
            let dateMatches = [];
            let match;
            while ((match = dateRegex.exec(text)) !== null) {
                let d, mStr, y;
                if (match[1]) { 
                    d = match[1]; mStr = months[match[2].toLowerCase()] || "01"; y = new Date().getFullYear();
                    if (new Date().getMonth() > 8 && parseInt(mStr) < 3) y++;
                } else { 
                    d = match[3]; mStr = match[4]; y = match[5].length === 2 ? "20" + match[5] : match[5];
                }
                dateMatches.push({
                    fullDate: `${y}-${mStr.padStart(2, '0')}-${d.padStart(2, '0')}`,
                    displayDate: `${d} ${match[2] || mStr}`,
                    index: match.index,
                    endIndex: match.index + match[0].length
                });
            }

            if (dateMatches.length === 0) return alert("Tarih formatÄ± algÄ±lanamadÄ±.");
            
            let count = 0;

            // 3. BloklarÄ± Ä°ÅŸle
            for (let i = 0; i < dateMatches.length; i++) {
                const currentDate = dateMatches[i];
                const nextDateIndex = (i + 1 < dateMatches.length) ? dateMatches[i + 1].index : text.length;
                const blockContent = text.substring(currentDate.endIndex, nextDateIndex);

                // 4. Saatleri Bul
                const timeRegex = /(\d{1,2}[:.]\d{2})/g;
                let tm;
                while ((tm = timeRegex.exec(blockContent)) !== null) {
                    const subBlockStart = tm.index + tm[0].length;
                    const nextTimeMatch = blockContent.substring(subBlockStart).search(/\d{1,2}[:.]\d{2}/);
                    const subBlockEnd = nextTimeMatch > -1 ? (subBlockStart + nextTimeMatch) : blockContent.length;
                    
                    const rawRow = blockContent.substring(subBlockStart, subBlockEnd);

                    // 5. Ders EÅŸleÅŸtirme
                    const foundCourse = courses.find(c => {
                        let code = c.name.split(' ')[0];
                        return rawRow.toLocaleUpperCase('tr-TR').includes(c.name.toLocaleUpperCase('tr-TR')) ||
                               (code.length > 3 && rawRow.includes(code));
                    });

                    if (foundCourse) {
                        if (parsedCandidates.some(p => p.id === foundCourse.id)) continue;

                        // --- 6. DERSLÄ°K BULMA (TIRAÅžLAMALI VERSÄ°YON) ---
                        let room = "";

                        // Etiketli arama (Derslik: GY1001...)
                        const labelMatch = rawRow.match(/(?:Derslik\/Oda|Derslik|Yer|Salon|Amfi|Lab|Oda)\s*[:]\s*([A-Za-z0-9\-\s]{2,15})/i);
                        
                        // Kodlu arama (GY1001, D102...)
                        const codeMatch = rawRow.match(/\b(GY\d{3,5}|D\d{3}|[AB]-?\d{3})\b/);

                        if (labelMatch) {
                            room = labelMatch[1].trim(); 
                        } else if (codeMatch) {
                            room = codeMatch[0];
                        } else if (/Online|Uzaktan/i.test(rawRow)) {
                            room = "Online";
                        }

                        // --- TIRAÅžLAMA Ä°ÅžLEMÄ° (YENÄ°) ---
                        // EÄŸer tire varsa, tireden sonrasÄ±nÄ± at. "GY1001 - D" -> "GY1001" olur.
                        if (room.includes('-')) {
                            room = room.split('-')[0].trim();
                        }
                        
                        // Ã‡Ã¶p temizliÄŸi
                        if (/^\d{1}$/.test(room)) room = ""; // Tek haneli sayÄ±larÄ± sil

                        count++;
                        parsedCandidates.push({ 
                            type: 'exam', 
                            id: foundCourse.id, 
                            name: foundCourse.name, 
                            date: currentDate.fullDate, 
                            room: room 
                        });

                        list.innerHTML += `
                        <div class="imp-item" onclick="toggleImp('${foundCourse.id}')" style="border-left: 4px solid var(--c3);">
                            <input type="checkbox" id="chk_${foundCourse.id}" class="imp-cb" checked onchange="updateImpBtn()">
                            <div class="imp-info">
                                <div class="imp-name">${foundCourse.name}</div>
                                <div class="imp-det">ðŸ“… ${currentDate.displayDate} â€¢ â° ${tm[1].replace('.', ':')} â€¢ ðŸ“ ${room || 'Derslik Yok'}</div>
                            </div>
                        </div>`;
                    }
                }
            }

            if (count > 0) { 
                list.style.display = 'block'; 
                document.getElementById('btnToggleAll').style.display = 'block'; 
                updateImpBtn(); 
            } else { 
                list.innerHTML = `<div style="padding:20px; text-align:center; color:var(--sub)">SÄ±nav bulunamadÄ±.</div>`; 
                list.style.display = 'block'; 
            }
        }

        // 3. Ortak Buton GÃ¼ncelleyici (YENÄ°)
        function updateImpBtn() {
            const btn = document.getElementById('btnImpSave');
            const selectedCount = Array.from(document.querySelectorAll('.imp-cb')).filter(cb => cb.checked).length;
            
            if (selectedCount === 0) {
                btn.style.display = 'none';
                return;
            }

            btn.style.display = 'block';
            
            // Hangi moddayÄ±z? (Ä°lk elemana bakarak anlarÄ±z)
            if (parsedCandidates.length > 0) {
                if (parsedCandidates[0].type === 'exam') {
                    btn.innerText = `SÄ±navlarÄ± Kaydet (${selectedCount}) âœ…`;
                    btn.style.background = "var(--c1)";
                    btn.onclick = saveImportedExams; // DoÄŸrudan fonksiyon referansÄ±
                } else {
                    btn.innerText = `SeÃ§ilenleri Kaydet (${selectedCount}) âœ…`;
                    btn.style.background = "var(--c1)";
                    btn.onclick = saveImportedCourses;
                }
            }
        }

        // 4. Checkbox TÄ±klama YardÄ±mcÄ±sÄ±
        function toggleImp(id) { 
            const c = document.getElementById('chk_' + id); 
            // TÄ±klama input'un kendisinden gelmediyse toggle yap
            if (event.target !== c) {
                c.checked = !c.checked; 
            }
            updateImpBtn(); // SayÄ±yÄ± gÃ¼ncelle
        }

        // 5. Kaydetme FonksiyonlarÄ± (DÃ¼zeltildi)
        function saveImportedExams() {
            try {
                let updatedCount = 0;
                parsedCandidates.forEach(p => {
                    if (p.type === 'exam') {
                        const chk = document.getElementById('chk_' + p.id);
                        if (chk && chk.checked) {
                            // ID karÅŸÄ±laÅŸtÄ±rmasÄ±nda esnek ol (==) Ã§Ã¼nkÃ¼ biri string biri number olabilir
                            const courseIndex = courses.findIndex(c => c.id == p.id);
                            if (courseIndex > -1) { 
                                courses[courseIndex].finalDate = p.date; 
                                courses[courseIndex].examRoom = p.room; 
                                updatedCount++; 
                            }
                        }
                    }
                });
                
                if (updatedCount > 0) { 
                    saveData(); 
                    refreshUI(); 
                    closeModal('importModal'); 
                    alert(updatedCount + " dersin sÄ±nav tarihi gÃ¼ncellendi! ðŸŽ‰"); 
                    updateDashboard(); 
                } else {
                    alert("SeÃ§ili sÄ±nav bulunamadÄ±.");
                }
            } catch(e) { alert("Kaydetme hatasÄ±: " + e.message); }
        }

        function saveImportedCourses() {
            try {
                let count = 0;
                parsedCandidates.forEach(p => {
                    if (p.type === 'course') {
                        const chk = document.getElementById('chk_' + p.id);
                        if (chk && chk.checked) {
                            courses.push({ 
                                id: Date.now() + Math.random(), 
                                name: p.name, day: p.day, time: p.time, room: p.room, 
                                limit: p.limit, absent: 0, absentDates: [], 
                                vize: "", proj: "", final: "", 
                                rates: { vize: 40, proj: 0, final: 60 }, average: null 
                            });
                            count++;
                        }
                    }
                });
                
                if (count > 0) {
                    saveData(); 
                    refreshUI(); 
                    closeModal('importModal'); 
                    alert(count + " ders eklendi! ðŸŽ‰"); 
                } else {
                    alert("SeÃ§ili ders yok.");
                }
            } catch(e) { alert("Kaydetme hatasÄ±: " + e.message); }
        }

        async function downloadBackup() {
            const dataStr = JSON.stringify(courses); const fileName = "UniHub_Yedek.json";
            if (typeof Capacitor !== 'undefined' && Capacitor.Plugins.Share) {
                try {
                    const result = await Capacitor.Plugins.Filesystem.writeFile({ path: fileName, data: dataStr, directory: 'CACHE', encoding: 'utf8' });
                    await Capacitor.Plugins.Share.share({ title: 'UniHub YedeÄŸi', text: 'UniHub ders programÄ± yedeÄŸim.', url: result.uri, dialogTitle: 'YedeÄŸi Nereye Kaydedelim?' });
                } catch (e) { alert("Yedekleme HatasÄ±: " + e.message); }
            } else {
                const a = document.createElement('a'); a.href = "data:text/json;charset=utf-8," + encodeURIComponent(dataStr); a.download = fileName; document.body.appendChild(a); a.click(); a.remove();
            }
        }
        function restoreBackup(i) {
            const f = i.files[0]; if (!f) return; const r = new FileReader();
            r.onload = e => { try { courses = JSON.parse(e.target.result); saveData(); refreshUI(); alert("YÃ¼klendi!"); closeModal('settingsModal'); } catch { alert("Hata!"); } };
            r.readAsText(f);
        }
        function checkChangelog() { if (localStorage.getItem('last_seen_version') !== CURRENT_VERSION) { document.getElementById('changelogModal').style.display = 'flex'; localStorage.setItem('last_seen_version', CURRENT_VERSION); } }
        function closeChangelog() { document.getElementById('changelogModal').style.display = 'none'; }

        function saveTermDates() {
            termDates = { start: document.getElementById('setTermStart').value, end: document.getElementById('setTermEnd').value, v1: document.getElementById('setVizeStart').value, v2: document.getElementById('setVizeEnd').value, f1: document.getElementById('setFinalStart').value, f2: document.getElementById('setFinalEnd').value };
            localStorage.setItem('term_dates', JSON.stringify(termDates)); alert("Takvim gÃ¼ncellendi! Widget ve Program yenileniyor... ðŸ”„"); refreshUI();
        }

        init();
    </script>
</body>

</html>